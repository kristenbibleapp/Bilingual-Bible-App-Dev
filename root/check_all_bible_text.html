<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Whole-Bible KJV Checker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    button { padding: 10px 14px; font-size: 16px; }
    .ok { color: #2f8f2f; }
    .bad { color: #c62828; }
    .muted { color: #666; }
    #results { margin-top: 12px; line-height: 1.5; white-space: pre-wrap; }
    details { margin: 8px 0; }
    summary { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Whole-Bible KJV Checker</h1>
  <p>Checks every <code>/bible/kjv/Book/NN.json</code> chapter against a reference KJV and shows mismatches.</p>
  <p class="muted">Open this page from your live site URL (not as a local file).</p>
  <button id="run">Run full check</button>
  <div id="progress" class="muted" style="margin-top:8px;"></div>
  <div id="results"></div>

  <script>
    // ---- CONFIG: your on-disk path prefix ----
    const ROOT_PREFIX = "./bible/kjv";  // <- matches: root/bible/kjv/Genesis/01.json

    // Canonical book list + chapter counts
    const BOOKS = [
      ["Genesis",50],["Exodus",40],["Leviticus",27],["Numbers",36],["Deuteronomy",34],
      ["Joshua",24],["Judges",21],["Ruth",4],["1 Samuel",31],["2 Samuel",24],
      ["1 Kings",22],["2 Kings",25],["1 Chronicles",29],["2 Chronicles",36],["Ezra",10],
      ["Nehemiah",13],["Esther",10],["Job",42],["Psalms",150],["Proverbs",31],
      ["Ecclesiastes",12],["Song of Solomon",8],["Isaiah",66],["Jeremiah",52],["Lamentations",5],
      ["Ezekiel",48],["Daniel",12],["Hosea",14],["Joel",3],["Amos",9],
      ["Obadiah",1],["Jonah",4],["Micah",7],["Nahum",3],["Habakkuk",3],
      ["Zephaniah",3],["Haggai",2],["Zechariah",14],["Malachi",4],
      ["Matthew",28],["Mark",16],["Luke",24],["John",21],["Acts",28],
      ["Romans",16],["1 Corinthians",16],["2 Corinthians",13],["Galatians",6],["Ephesians",6],
      ["Philippians",4],["Colossians",4],["1 Thessalonians",5],["2 Thessalonians",3],["1 Timothy",6],
      ["2 Timothy",4],["Titus",3],["Philemon",1],["Hebrews",13],["James",5],
      ["1 Peter",5],["2 Peter",3],["1 John",5],["2 John",1],["3 John",1],
      ["Jude",1],["Revelation",22]
    ];

    // If bible-api.com blocks CORS for you, set this to true.
    const USE_CORS_PROXY = false; 
    const REF_BASE = "https://bible-api.com";

    const progress = (msg) => document.getElementById("progress").textContent = msg;
    const resultsDiv = document.getElementById("results");

    const norm = (s) => s
      .replace(/\u201c|\u201d/g,'"').replace(/\u2018|\u2019/g,"'")
      .replace(/\s+/g,' ').trim();

    const normStrict = (s) => norm(s).replace(/[^\w\s]/g,'').replace(/\s+/g,' ').trim().toLowerCase();

    function pad2(n){ return n < 10 ? `0${n}` : `${n}`; }

    async function fetchLocalChapter(book, ch){
      // Try NN.json first (01-09), then n.json as fallback
      const tryUrls = [
        `${ROOT_PREFIX}/${book}/${pad2(ch)}.json`,
        `${ROOT_PREFIX}/${book}/${ch}.json`
      ];
      for (const url of tryUrls){
        const r = await fetch(url);
        if (r.ok){
          const js = await r.json();
          const verses = Array.isArray(js.verses) ? js.verses : [];
          const texts = verses.length && typeof verses[0] === "object"
            ? verses.map(v => `${v.text ?? ""}`)
            : verses.map(v => `${v}`);
          return texts;
        }
      }
      throw new Error(`Missing ${ROOT_PREFIX}/${book}/${pad2(ch)}.json`);
    }

    async function fetchRefChapter(book, ch){
      const qBook = encodeURIComponent(book);
      const url = `${REF_BASE}/${qBook}%20${ch}?translation=kjv`;
      const finalUrl = USE_CORS_PROXY
        ? `https://r.jina.ai/http://bible-api.com/${qBook}%20${ch}?translation=kjv`
        : url;
      const r = await fetch(finalUrl);
      if (!r.ok){ throw new Error(`Ref fetch failed ${book} ${ch}`); }
      const js = await r.json();
      const verses = Array.isArray(js.verses) ? js.verses : [];
      return verses.map(v => norm(v.text ?? ""));
    }

    function firstDiff(localArr, refArr){
      const n = Math.min(localArr.length, refArr.length);
      for (let i=0;i<n;i++){
        if (normStrict(localArr[i]) !== normStrict(refArr[i])){
          return { v: i+1, local: localArr[i], ref: refArr[i] };
        }
      }
      if (localArr.length !== refArr.length){
        return { v: n+1, local: `[local length=${localArr.length}]`, ref: `[ref length=${refArr.length}]` };
      }
      return null;
    }

    async function run(){
      resultsDiv.textContent = "";
      let total=0, ok=0, bad=0, missing=0, errs=0;
      for (const [book, maxCh] of BOOKS){
        const head = document.createElement("div");
        head.innerHTML = `<strong>${book}</strong>`;
        resultsDiv.appendChild(head);

        for (let ch=1; ch<=maxCh; ch++){
          total++;
          progress(`Checking ${book} ${ch} …`);
          try{
            const local = await fetchLocalChapter(book, ch);
            const ref = await fetchRefChapter(book, ch);
            const diff = firstDiff(local, ref);
            const line = document.createElement("div");
            if (!diff){
              ok++;
              line.className = "ok";
              line.textContent = `✓ ${book} ${ch}`;
            }else{
              bad++;
              line.className = "bad";
              const detail = document.createElement("details");
              const sum = document.createElement("summary");
              sum.textContent = `✗ ${book} ${ch} (first diff v${diff.v})`;
              const body = document.createElement("div");
              body.innerHTML = `<div><em>Local:</em> ${diff.local}</div><div><em>Ref:</em> ${diff.ref}</div>`;
              detail.appendChild(sum);
              detail.appendChild(body);
              line.appendChild(detail);
            }
            resultsDiv.appendChild(line);
          }catch(e){
            errs++;
            if (String(e).includes("Missing")) missing++;
            const line = document.createElement("div");
            line.className = "bad";
            line.textContent = `! ${book} ${ch} -- ${e.message || e}`;
            resultsDiv.appendChild(line);
          }
          await new Promise(r => setTimeout(r, 200)); // gentle throttle
        }
      }
      progress(`Done. Total: ${total} | OK: ${ok} | Mismatches: ${bad} | Missing: ${missing} | Errors: ${errs}`);
    }

    document.getElementById("run").addEventListener("click", run);
  </script>
</body>
</html>